---
title: "QMSS G5072 Homework 10"
author: Ting An Lai
date: 2019-11-28
always_allow_html: yes
output: 
  html_document:
    keep_md: true
---

Practicing SQL Queries
============================

For this homework, I have prepared a MySQL database hosted on Amazon Web Services. Use the code below to connect to the database.

```{r}                
library(DBI)
witch_con <- dbConnect(
  RMySQL::MySQL(),
  user = 'student',
  password = 'mds-is-fun',
  dbname = 'witchcraft',
  host = 'tbrambor.csbmzoea3lu9.us-east-1.rds.amazonaws.com',
  port = 3306
)

witch_con
```

The data comes from a project on "Scottish Witchcraft" and contains all people known to have been accused of witchcraft in early modern Scotland. There is information on where and when they were accused, how they were tried, what their fate was etc.

>Julian Goodare, Lauren Martin, Joyce Miller and Louise Yeoman, ‘The Survey of Scottish Witchcraft’, http://www.shca.ed.ac.uk/Research/witches/) 

#### 1. Getting to know the data

a) Show a list of the tables included in the database.

```{sql, connection="witch_con"}
-- dbListTables(witch_con)
SHOW TABLES
```



b) Display the column names for the table `accused`.  

```{sql, connection="witch_con"}
DESCRIBE accused
```

c) How many people are included in the accused table?  

```{sql, connection="witch_con"}

SELECT COUNT(*) FROM accused

```
d) Display the columns `firstname`, `sex`, and `age` for 5 cases in the `accused` table. 

```{sql, connection="witch_con"}
SELECT firstname, sex, age 
FROM accused

```
c) Looks like the `age` is missing for some observations. Count the number of nonmissing values for age in the data.  
```{sql, connection="witch_con"}
SELECT COUNT(age)
FROM accused;

```
d) Show a list of unique `occupation`s.

```{sql, connection="witch_con"}

SELECT DISTINCT occupation
FROM accused

```

#### 2. Seeing the Devil

Let's look at some appearances of the devil in the `devilappearance` table.

a) List the unique `devil_type`s in the data.  
```{sql, connection="witch_con"}
SELECT DISTINCT devil_type
FROM devilappearance
```

b) There is also a little description of the type of the devil sighting in the `devil_text`
column. How many of the sightings mention the word "black" in the description?
```{sql, connection="witch_con"}
SELECT COUNT(*)
FROM devilappearance
WHERE devil_text LIKE ('%black%')
```


c) What proportion of the devils (in `devil_type`) are male? 
```{sql, connection="witch_con"}
SELECT COUNT(*)
FROM devilappearance
WHERE devil_type IN ('Male')

```


#### 3. The trial

Let's take a look at the information on the `trial`.

```{sql, connection='witch_con'}
DESCRIBE trial

```

a) What are the average and maximum numbers of male and female accusers?
```{sql,  connection='witch_con'}
SELECT AVG(female_accusers), MAX(female_accusers)
FROM trial;
```

```{sql, connection='witch_con'}

SELECT AVG(male_accusers), MAX(male_accusers)
FROM trial;
```


b) Count the number of `sentence`s by sentence type. List them in a table (in descending order), excluding missing values. Rename the column headings to something sensible.
```{sql, connection='witch_con', output.var="mydataframe"}
SELECT sentence, COUNT(*)
FROM trial
GROUP BY sentence 
ORDER BY COUNT(*) DESC
```



```{r}
mydataframe
```



c) Do the number of accusers matter for the `verdict`? Compare the average number of accusers by the type of verdict. Again make sure the table is sorted and the headings make sense. 

```{sql, connection='witch_con'}
SELECT AVG(female_accusers+male_accusers)
FROM trial
GROUP BY verdict

```





#### 4. Tortured Truth (Bonus)

_Note: This part is optional. We spent little time on joins in lecture, so I encourage you to try it but feel free to skip._

a) Left join the `trial` and `confession` tables. For what share of trials does the database record confessions? Create a results table with the number of all trials, the number of confessions, and the share of trials with confessions recorded.
>  

```{sql, connection='witch_con', output.var='mydataframe'}
SELECT *
FROM trial LEFT JOIN confession 
ON trial.row_names=confession.row_names;
```


```{r}
trial_dim  = dim(mydataframe)
trial_row = trial_dim[1]
conf_total = sum (!is.na(mydataframe$confessionref))
share = conf_total/trial_dim[1]
print(share)

tb <- matrix(c(trial_row, conf_total, share))
rownames(tb) <- c("number_of_trials", "number_of_confessions", "share_of_trials")
tb <- as.table(tb)
tb
```

```{sql, connection='witch_con'}
SELECT *
FROM torture
```



b) Only a small number of trials have records of torture. Is there a higher share of confessions among trials with records of torture than trials without such record? _Hint:_ You will need to merge on the `confession` table. 

> If joinning the all trial, torture, and confession tables, there are 110 records of confessions which is 0.034 of all the trials. In comparison with trial table without torture, there were 941 records of confession which was 0.29 of all the trial records.

```{sql, connection='witch_con', output.var='mydataframe'}
SELECT *
FROM trial 
LEFT JOIN torture ON trial.row_names=torture.row_names
LEFT JOIN confession ON torture.row_names=confession.row_names


```


```{r}
#mydataframe
trail_dim  <- dim(mydataframe)
conf_num <- sum(!is.na(mydataframe$confessionrec))
share_2 = conf_num/trial_dim[1]
print(share_2)

tb_2 <- matrix(c(trial_row, conf_num, share_2))
rownames(tb_2) <- c("number_of_trials", "number_of_confessions", "share_of_trials")
tb_2 <- as.table(tb_2)
print(tb)
print(tb_2)

```


### Submission

Please follow the [instructions](/Exercises/homework_submission_instructions.md) to submit your homework. The homework is due on Wedneday, December 4 at 5pm.