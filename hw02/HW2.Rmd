---
title: "hw02"
author: "Ting An Lai"
date: '2019-09-29'
output:
  html_notebook:
    toc: yes
  html_document:
    df_print: paged
    toc: yes
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, cache=FALSE)
```


```{r, message = FALSE}
if (!require("tidyverse")) install.packages("tidyverse")
if (!require("kableExtra")) install.packages ('kableExtra')
if (!require("DT")) install.packages('DT')
library(DT)
library(dplyr)
library(tidyverse)
library(tidyr)
library(knitr)
```

## Import Data
```{r}
data = read.csv("/Users/tinganlai/Documents/GitHub/Lai_Ting_An/hw02/U.S._Chronic_Disease_Indicators__CDI_.csv")
```

## Selection of Data and Tidying
### 1. Remove all the columns do not need in analysis for *Binge Drinking* and *Poverty* Question's *Crude Prevalence*
```{r}
BDadult <- data %>%
  filter (Question == "Binge drinking prevalence among adults aged >= 18 years" | Question == "Poverty") %>%
  filter (DataValueType == "Crude Prevalence" ) %>%
  filter (StratificationCategory1 == "Gender" | StratificationCategory1 == "Overall") %>%
  spread (key = StratificationCategory1, value = Stratification1) %>%
  arrange (desc(YearEnd))


```

### 2. Tidying dataframe and renaming
```{r}
# create poverty subtable
poverty_df <- BDadult %>%
  select (year = YearEnd, state = LocationDesc, stateabb = LocationAbbr,  question = Question, crudeprevalence = DataValue, gender = Gender, overall = Overall) %>%
  spread (key = gender, value = crudeprevalence) %>%
  filter (question == "Poverty" & overall == "Overall") 
# rename poverty subtable
poverty_columnname <- c('year', 'state', 'stateabb', 'question', 'overall', 'Female', 'Male', 'poverty')
colnames(poverty_df) <- poverty_columnname
poverty_df <- select (poverty_df, year, state, stateabb, poverty)

# create binge subtable
binge_df <- BDadult %>%
 select (year = YearEnd, state = LocationDesc, stateabb = LocationAbbr,  question = Question, crudeprevalence = DataValue, gender = Gender, overall = Overall) %>%
  spread (key = gender, value = crudeprevalence) %>%
  filter (question == "Binge drinking prevalence among adults aged >= 18 years") %>%
  arrange (desc(question)) 

#rename binge subtalbe
binge_columnname <- c('year', 'state', 'stateabb', 'question', 'overall', 'binge_female', 'binge_male', 'binge_all')
colnames(binge_df) <- binge_columnname

#create binge_all subtable
binge_overall_df <- binge_df %>%
  filter (is.na (binge_female) & is.na (binge_male)) %>%
  select (year, state, stateabb, binge_all)
  
#create binge_female, male subtalbe
binge_female_male_df <- binge_df %>%
  filter (is.na (binge_all)) %>%
  select (year, state, stateabb, binge_female, binge_male)

```


### 3. Joining poverty, binge_overall, binge_female, and binge_male table (I preserved the 2010 poverty crude prevalence data)
```{r}
#joining poverty, binge_all, binge_female, binge_male subtables
binge_clean <- poverty_df %>%
  left_join (binge_overall_df) %>%
  left_join(binge_female_male_df) 

datatable (binge_clean)
```

### Write into csv
```{r}
write.csv(binge_clean,"/Users/tinganlai/Documents/GitHub/Lai_Ting_An/hw02/binge_clean.csv", row.names = FALSE)
```

## 4. Data Transformation and Summary Results
```{r, message = FALSE}
question4_df <- binge_clean 

#select needed variables, select the most recent year, arrange in binge_all order
question4_df <- question4_df %>%
  select(year, state, binge_all, binge_male, binge_female) %>%
  arrange(desc(year)) %>%
  filter(year == question4_df$year[nrow(question4_df)]) %>%
  arrange(desc(binge_all))

#select top ten binge_all states
table_4 <- question4_df[1:10,]
kable (table_4)
```

## 5. Make Scatterplot
In general, when poverty crude prevalence is under 20, the poverty crude prevalence has a negative correlation with binge drinking overall crude prevalence. In other words, states that are more wealthy has a higher overall binge drinking growth rate. However, there are few states that scored extremely high in poverty, like Puerto Rico; therefore, the smooth method has less confidence in predicting the overall binge drinking rate for poverty crude prevalence over 30. This could be seen in the gradually wider confidence interval (grey area) in the plot.

```{r}
if (!require("ggplot2")) install.packages('ggplot2')
library(ggplot2)
```

```{r, message=FALSE, warning = FALSE}
question5_df <- binge_clean
#correct data type
question5_df$poverty <- as.numeric(levels(question5_df$poverty))[question5_df$poverty]
question5_df$binge_all <- as.numeric(levels(question5_df$binge_all))[question5_df$binge_all]

#poverty as predictor for binge_all
ggplot (question5_df, aes (x=question5_df$poverty , y = question5_df$binge_all)) +
labs (x = "poverty") +
labs (y = "binge_all") +
labs (title = "Correlation Scatter Plot") +
geom_point() +
geom_smooth()
```

## 6. Summarize over time
```{r, message = FALSE, warning = FALSE}
question6_df <- binge_clean %>%
  arrange (state) %>%
  filter (!is.na(binge_all) & !is.na(binge_female) & !is.na(binge_male)) #remove NA binge rows

question6_df$binge_all <- as.numeric(levels(question6_df$binge_all))[question6_df$binge_all] #correct data type

AGR_fixed <- question6_df %>% 
  mutate (diff_crude = binge_all[-1] - binge_all, AGR = diff_crude/binge_all*100) %>%# calculate annual growth rate
  filter (year != "2016")#remove the wrong AGR rows in 2016


#calculate AGR for binge_all and select the top 5 AGR binge_all
Top5Increase_AGR <- AGR_fixed %>%
  arrange (state) %>%
  group_by(state) %>%
  summarize (AverageAnnualGrowthRate = mean (AGR)) %>%
  top_n(n=5) %>%
  arrange(desc(AverageAnnualGrowthRate))

#calculate AGR for binge_all and select the smallest 5 AGR binge_all
Top5Decrease_AGR <- AGR_fixed %>%
  arrange (state) %>%
  group_by(state) %>%
  summarize (AverageAnnualGrowthRate = mean (AGR)) %>%
  top_n(n=-5) %>%
  arrange(desc(AverageAnnualGrowthRate))

AGR <- AGR_fixed %>%
  arrange (state) %>%
  group_by(state) %>%
  summarize (AverageAnnualGrowthRate = mean (AGR))%>%
  arrange(AverageAnnualGrowthRate)

#Average Annual Growth Rates
kable(AGR)
#Top 5 Increase AGR
kable (Top5Increase_AGR)
#Top 5 Decrease AGR
kable (Top5Decrease_AGR)
```


